!function(global,factory){if("function"==typeof define&&define.amd)define(["exports"],factory);else if("undefined"!=typeof exports)factory(exports);else{var mod={exports:{}};factory(mod.exports),global.event_emitter=mod.exports}}(this,function(exports){"use strict";function EventEmitter(){function addListener(type,fn,ctx,once){if("function"!=typeof fn)throw new TypeError("listener must be a function");events[type]||(events[type]=[]),events[type].push({fn:fn,ctx:ctx,once:once})}var events={};this.on=function(type,fn,ctx){return addListener(type,fn,ctx,!1),this},this.once=function(type,fn,ctx){return addListener(type,fn,ctx,!0),this},this.off=function(type,fn){var listeners=events[type];if(!listeners)return this;if(fn)for(var i=0;i<listeners.length;i+=1)listeners[i].fn===fn&&(listeners.splice(i,1),i-=1);else delete events[type];return this},this.emit=function(type){var listeners=events[type];if(!listeners||!listeners.length)return this;for(var _len=arguments.length,args=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++)args[_key-1]=arguments[_key];for(var i=0;i<listeners.length;i+=1){try{listeners[i].fn.apply(listeners[i].ctx||null,args)}catch(err){console.error(err)}listeners[i].once&&(listeners.splice(i,1),i-=1)}return this}}Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=EventEmitter}),function(global,factory){if("function"==typeof define&&define.amd)define(["exports","./event_emitter"],factory);else if("undefined"!=typeof exports)factory(exports,require("./event_emitter"));else{var mod={exports:{}};factory(mod.exports,global.event_emitter),global.fallback_thread=mod.exports}}(this,function(exports,_event_emitter){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _event_emitter2=_interopRequireDefault(_event_emitter),_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),Context=function(){function Context(parent){_classCallCheck(this,Context),this.__parent__=parent,this.__emitter__=new _event_emitter2["default"]}return _createClass(Context,[{key:"on",value:function(type,fn){return this.__emitter__.on(type,fn),this}},{key:"once",value:function(type,fn){return this.__emitter__.once(type,fn),this}},{key:"off",value:function(type,fn){return this.__emitter__.off(type,fn),this}},{key:"emit",value:function(type){for(var _parent__$__emitter_,_len=arguments.length,args=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++)args[_key-1]=arguments[_key];return(_parent__$__emitter_=this.__parent__.__emitter__).emit.apply(_parent__$__emitter_,[type].concat(args)),this}},{key:"log",value:function(){var _console;(_console=console).log.apply(_console,arguments)}}]),Context}(),Thread=function(){function Thread(fn){for(var _this=this,_len2=arguments.length,args=Array(_len2>1?_len2-1:0),_key2=1;_key2<_len2;_key2++)args[_key2-1]=arguments[_key2];_classCallCheck(this,Thread),this.__emitter__=new _event_emitter2["default"],this.__context__=new Context(this),setTimeout(function(){var result=void 0;try{result=fn.apply(_this.__context__,args)}catch(err){_this.__emitter__.emit("error",err.stack)}result&&(result.then?result.then(function(data){return _this.__emitter__.emit("done",data)},function(err){return _this.__emitter__.emit("error",err.stack)}):_this.__emitter__.emit("done",result))})}return _createClass(Thread,[{key:"on",value:function(type,fn){return this.__emitter__.on(type,fn),this}},{key:"once",value:function(type,fn){return this.__emitter__.once(type,fn),this}},{key:"off",value:function(type,fn){return this.__emitter__.off(type,fn),this}},{key:"emit",value:function(type){for(var _context__$__emitter,_len3=arguments.length,args=Array(_len3>1?_len3-1:0),_key3=1;_key3<_len3;_key3++)args[_key3-1]=arguments[_key3];return(_context__$__emitter=this.__context__.__emitter__).emit.apply(_context__$__emitter,[type].concat(args)),this}},{key:"kill",value:function(){}}],[{key:"start",value:function(fn){for(var _len4=arguments.length,args=Array(_len4>1?_len4-1:0),_key4=1;_key4<_len4;_key4++)args[_key4-1]=arguments[_key4];return new(Function.prototype.bind.apply(Thread,[null].concat([fn],args)))}}]),Thread}();exports["default"]=Thread}),function(global,factory){if("function"==typeof define&&define.amd)define(["exports","./fallback_thread","./worker_thread"],factory);else if("undefined"!=typeof exports)factory(exports,require("./fallback_thread"),require("./worker_thread"));else{var mod={exports:{}};factory(mod.exports,global.fallback_thread,global.worker_thread),global.index=mod.exports}}(this,function(exports,_fallback_thread,_worker_thread){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}Object.defineProperty(exports,"__esModule",{value:!0});var _fallback_thread2=_interopRequireDefault(_fallback_thread),_worker_thread2=_interopRequireDefault(_worker_thread),IS_NODE=!new Function("try { return this === window; } catch (e) { return false; }"),Thread=void 0;if(IS_NODE)global.Worker=global.require("tiny-worker"),Thread=_worker_thread2["default"];else{var BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder,createObjectURL=window.URL&&window.URL.createObjectURL||window.webkitURL&&window.webkitURL.createObjectURL,Blob=window.Blob,BLOB_CONSTRUCTOR=(Blob||!1)&&4===new Blob(["test"]).size;Thread=Blob&&createObjectURL&&(BLOB_CONSTRUCTOR||BlobBuilder)?_worker_thread2["default"]:_fallback_thread2["default"]}exports["default"]=Thread}),function(global,factory){if("function"==typeof define&&define.amd)define(["exports","./worker_thread_loader"],factory);else if("undefined"!=typeof exports)factory(exports,require("./worker_thread_loader"));else{var mod={exports:{}};factory(mod.exports,global.worker_thread_loader),global.spawn_worker=mod.exports}}(this,function(exports,_worker_thread_loader){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++)arr2[i]=arr[i];return arr2}return Array.from(arr)}function spawnWorker(){var worker=new Worker(_worker_thread_loader2["default"]);return worker.contexts={},worker.lastContext=null,worker.messageQueue=[],worker.onmessage=function(ev){var _worker$lastContext$t,_console,_console2;if("worker_ready"===ev.data.type){for(;worker.messageQueue.length;)worker.postMessage(worker.messageQueue.shift());return void(worker.ready=!0)}switch(worker.lastContext=worker.contexts[ev.data.id],(_worker$lastContext$t=worker.lastContext.thread.__emitter__).emit.apply(_worker$lastContext$t,[ev.data.type].concat(_toConsumableArray(ev.data.args))),ev.data.type){case"done":threadPool.push(worker);break;case"log":(_console=console).log.apply(_console,_toConsumableArray(ev.data.args));break;case"error":(_console2=console).error.apply(_console2,_toConsumableArray(ev.data.args))}},worker.onerror=function(err){worker.lastContext.thread.__emitter__.emit("error",err),console.error(err.message,err.stack),worker.terminate()},worker}Object.defineProperty(exports,"__esModule",{value:!0}),exports.spawnWorker=exports.threadPool=void 0;var _worker_thread_loader2=_interopRequireDefault(_worker_thread_loader),threadPool=[];exports.threadPool=threadPool,exports.spawnWorker=spawnWorker}),function(global,factory){if("function"==typeof define&&define.amd)define(["exports","./event_emitter","./spawn_worker"],factory);else if("undefined"!=typeof exports)factory(exports,require("./event_emitter"),require("./spawn_worker"));else{var mod={exports:{}};factory(mod.exports,global.event_emitter,global.spawn_worker),global.worker_thread=mod.exports}}(this,function(exports,_event_emitter,_spawn_worker){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _event_emitter2=_interopRequireDefault(_event_emitter),_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),seq=0,Thread=function(){function Thread(fn){for(var _len=arguments.length,args=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++)args[_key-1]=arguments[_key];_classCallCheck(this,Thread),_spawn_worker.threadPool.length?this.__worker__=_spawn_worker.threadPool.shift():this.__worker__=(0,_spawn_worker.spawnWorker)(),this.__id__=(new Date).getTime().toString()+(seq+=1),this.__worker__.contexts[this.__id__]=this.__worker__.lastContext={thread:this},this.__emitter__=new _event_emitter2["default"];var msg={args:args,id:this.__id__,src:fn.toString(),type:"source"};this.__worker__.ready?this.__worker__.postMessage(msg):this.__worker__.messageQueue.push(msg)}return _createClass(Thread,[{key:"on",value:function(type,fn){return this.__emitter__.on(type,fn),this}},{key:"once",value:function(type,fn){return this.__emitter__.once(type,fn),this}},{key:"off",value:function(type,fn){return this.__emitter__.off(type,fn),this}},{key:"emit",value:function(type){for(var _len2=arguments.length,args=Array(_len2>1?_len2-1:0),_key2=1;_key2<_len2;_key2++)args[_key2-1]=arguments[_key2];var msg={args:args,type:type,id:this.__id__};return this.__worker__.ready?this.__worker__.postMessage(msg):this.__worker__.messageQueue.push(msg),this}},{key:"kill",value:function(){this.__worker__.terminate()}}],[{key:"start",value:function(fn){for(var _len3=arguments.length,args=Array(_len3>1?_len3-1:0),_key3=1;_key3<_len3;_key3++)args[_key3-1]=arguments[_key3];return new(Function.prototype.bind.apply(Thread,[null].concat([fn],args)))}}]),Thread}();exports["default"]=Thread}),function(global,factory){if("function"==typeof define&&define.amd)define(["exports","./event_emitter"],factory);else if("undefined"!=typeof exports)factory(exports,require("./event_emitter"));else{var mod={exports:{}};factory(mod.exports,global.event_emitter),global.worker_thread_loader=mod.exports}}(this,function(exports,_event_emitter){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}function threadLoader(){function Context(id){this.__id__=id,this.__emitter__=new self.EventEmitter}var contexts={};Context.prototype.on=function(type,fn){return this.__emitter__.on(type,fn),this},Context.prototype.once=function(type,fn){return this.__emitter__.once(type,fn),this},Context.prototype.off=function(type,fn){return this.__emitter__.off(type,fn),this},Context.prototype.emit=function(type){for(var _len=arguments.length,args=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++)args[_key-1]=arguments[_key];return postMessage({args:args,type:type,id:this.__id__}),this},Context.prototype.log=function(){for(var _len2=arguments.length,args=Array(_len2),_key2=0;_key2<_len2;_key2++)args[_key2]=arguments[_key2];this.emit.apply(this,["log"].concat(args))},onmessage=function onMessage(ev){switch(ev.data.type){case"source":var _ret=function(){var context=contexts[ev.data.id]=new Context(ev.data.id),result=void 0;try{result=eval("("+ev.data.src+")").apply(context,ev.data.args)}catch(err){return context.emit("error",err.stack),"break"}return result&&(result.then?result.then(function(data){return context.emit("done",data)},function(err){return context.emit("error",err.stack)}):context.emit("done",result)),"break"}();if("break"===_ret)break;default:var _context=contexts[ev.data.id];try{_context.__emitter__.emit.apply(_context.__emitter__.emit,[ev.data.type].concat(ev.data.args))}catch(err){_context.emit("error",err.stack)}}},postMessage({type:"worker_ready"})}Object.defineProperty(exports,"__esModule",{value:!0});var _event_emitter2=_interopRequireDefault(_event_emitter),loaderSrc="\n"+_event_emitter2["default"]+";\n("+threadLoader+")();\n",loaderFunction="(function () {\n    "+loaderSrc+";\n})",IS_NODE=!new Function("try { return this === window; } catch (e) { return false; }"),workerThreadLoader=void 0;if(IS_NODE)workerThreadLoader=eval(loaderFunction);else{var BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder,createObjectURL=window.URL&&window.URL.createObjectURL||window.webkitURL&&window.webkitURL.createObjectURL,Blob=window.Blob,BLOB_CONSTRUCTOR=(Blob||!1)&&4===new Blob(["test"]).size,loaderBlob=void 0;if(BLOB_CONSTRUCTOR)loaderBlob=new Blob([loaderSrc]);else if(BlobBuilder){var builder=new BlobBuilder;builder.append(loaderSrc),loaderBlob=builder.getBlob()}createObjectURL&&(workerThreadLoader=createObjectURL(loaderBlob))}exports["default"]=workerThreadLoader});
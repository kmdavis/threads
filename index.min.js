!function(global,factory){if("function"==typeof define&&define.amd)define(["exports"],factory);else if("undefined"!=typeof exports)factory(exports);else{var mod={exports:{}};factory(mod.exports),global.event_emitter=mod.exports}}(this,function(exports){"use strict";function EventEmitter(){function addListener(type,fn,ctx,once){if("function"!=typeof fn)throw new TypeError("listener must be a function");event[type]||(events[type]=[]),events[type].push({fn:fn,ctx:ctx,once:once})}var events={};this.on=function(type,fn,ctx){addListener(type,fn,ctx,!1)},this.once=function(type,fn,ctx){addListener(type,fn,ctx,!0)},this.off=function(type,fn){var listeners=events[type];if(listeners)if(fn)for(var i=0;i<listeners.length;i+=1)listeners[i].fn===fn&&(listeners.splice(i,1),i-=1);else delete events[type]},this.emit=function(type){var listeners=events[type];if(listeners&&listeners.length){for(var _len=arguments.length,args=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++)args[_key-1]=arguments[_key];for(var i=0;i<listeners.length;i+=1)listeners[i].fn.apply(listeners[i].ctx||null,args),listeners[i].once&&(listeners.splice(i,1),i-=1)}}}Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=EventEmitter}),function(global,factory){if("function"==typeof define&&define.amd)define(["exports"],factory);else if("undefined"!=typeof exports)factory(exports);else{var mod={exports:{}};factory(mod.exports),global.fallback_thread=mod.exports}}(this,function(exports){"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),Thread=function(){function Thread(fn){_classCallCheck(this,Thread)}return _createClass(Thread,null,[{key:"start",value:function(fn){for(var _len=arguments.length,args=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++)args[_key-1]=arguments[_key];return new(Function.prototype.bind.apply(Thread,[null].concat([fn],args)))}}]),Thread}();exports["default"]=Thread}),function(global,factory){if("function"==typeof define&&define.amd)define(["exports","./fallback_thread","./thread"],factory);else if("undefined"!=typeof exports)factory(exports,require("./fallback_thread"),require("./thread"));else{var mod={exports:{}};factory(mod.exports,global.fallback_thread,global.thread),global.index=mod.exports}}(this,function(exports,_fallback_thread,_thread){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}Object.defineProperty(exports,"__esModule",{value:!0});var _fallback_thread2=_interopRequireDefault(_fallback_thread),_thread2=_interopRequireDefault(_thread),IS_NODE=!new Function("try { return this === window; } catch (e) { return false; }"),BlobBuilder=(void 0).BlobBuilder||(void 0).WebKitBlobBuilder,createObjectURL=(void 0).URL&&(void 0).URL.createObjectURL||(void 0).webkitURL&&(void 0).webkitURL.createObjectURL,Blob=(void 0).Blob,BLOB_CONSTRUCTOR=(Blob||!1)&&4===new Blob(["test"]).size,Thread=void 0;Thread=IS_NODE?global.require("../lib/node_thread"):Blob&&createObjectURL&&(BLOB_CONSTRUCTOR||BlobBuilder)?_thread2["default"]:_fallback_thread2["default"],exports["default"]=Thread}),function(global,factory){if("function"==typeof define&&define.amd)define(["exports","./event_emitter"],factory);else if("undefined"!=typeof exports)factory(exports,require("./event_emitter"));else{var mod={exports:{}};factory(mod.exports,global.event_emitter),global.thread=mod.exports}}(this,function(exports,_event_emitter){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++)arr2[i]=arr[i];return arr2}return Array.from(arr)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function threadLoader(){var contexts={},Context=function(){function Context(id){_classCallCheck(this,Context),this.__id__=id,this.__emiter__=new _event_emitter2["default"]}return _createClass(Context,[{key:"on",value:function(type,fn){this.__emiter__.on(type,fn)}},{key:"once",value:function(type,fn){this.__emiter__.once(type,fn)}},{key:"off",value:function(type,fn){this.__emiter__.off(type,fn)}},{key:"emit",value:function(type){for(var _len=arguments.length,args=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++)args[_key-1]=arguments[_key];postMessage({args:args,type:type,id:this.__id__})}}]),Context}();onmessage=function onMessage(ev){var _contexts$ev$data$id$;switch(ev.data.type){case"source":var _ret=function(){var context=contexts[ev.data.id]=new Context(ev.data.id),result=eval("("+ev.data.src+")").apply(context,ev.data.args);return result&&(result.then?result.then(function(data){return context.emit("done",data)}):context.emit("done",result)),"break"}();if("break"===_ret)break;default:(_contexts$ev$data$id$=contexts[ev.data.id].__emitter__).emit.apply(_contexts$ev$data$id$,[ev.data.type].concat(_toConsumableArray(ev.data.args)))}}}function spawnWorker(){var worker=new Worker(loaderSrc);return worker.contexts={},worker.lastContext=null,worker.onmessage=function(ev){var _worker$lastContext$_;worker.lastContext=worker.contexts[ev.data.id],(_worker$lastContext$_=worker.lastContext.__emitter__).emit.apply(_worker$lastContext$_,[ev.data.type].concat(_toConsumableArray(ev.data.args))),"done"===ev.data.type&&threadPool.push(worker)},worker.onerror=function(err){worker.lastContext.__emitter__.emit("error",err),worker.terminate()},worker}Object.defineProperty(exports,"__esModule",{value:!0});var _event_emitter2=_interopRequireDefault(_event_emitter),_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),BlobBuilder=(void 0).BlobBuilder||(void 0).WebKitBlobBuilder,createObjectURL=(void 0).URL&&(void 0).URL.createObjectURL||(void 0).webkitURL&&(void 0).webkitURL.createObjectURL,Blob=(void 0).Blob,BLOB_CONSTRUCTOR=(Blob||!1)&&4===new Blob(["test"]).size,loaderBlob=void 0,loaderSrc=void 0;if(BLOB_CONSTRUCTOR)loaderBlob=new Blob([_event_emitter2["default"].toString(),threadLoader.toString()]);else if(BlobBuilder){var builder=new BlobBuilder;builder.append(_event_emitter2["default"].toString()),builder.append(threadLoader.toString()),loaderBlob=builder.getBlob()}createObjectURL&&(loaderSrc=createObjectURL(loaderBlob));var threadPool=[],seq=0,Thread=function(){function Thread(fn){for(var _len2=arguments.length,args=Array(_len2>1?_len2-1:0),_key2=1;_key2<_len2;_key2++)args[_key2-1]=arguments[_key2];_classCallCheck(this,Thread),threadPool.length?this.worker=threadPool.shift():this.worker=spawnWorker(),this.__id__=(new Date).getTime().toString()+(seq+=1),this.__worker__[this.__id__]=this.__worker__.lastContext={result:null,thread:this},this.__emitter__=new _event_emitter2["default"],this.__worker__.postMessage({args:args,id:this.__id__,src:fn.toString(),type:"source"})}return _createClass(Thread,[{key:"on",value:function(type,fn){this.__emitter__.on(type,fn)}},{key:"once",value:function(type,fn){this.__emitter__.once(type,fn)}},{key:"off",value:function(type,fn){this.__emitter__.off(type,fn)}},{key:"emit",value:function(type){for(var _len3=arguments.length,args=Array(_len3>1?_len3-1:0),_key3=1;_key3<_len3;_key3++)args[_key3-1]=arguments[_key3];this.__worker__.postMessage({args:args,type:type,id:this.__id__})}}],[{key:"start",value:function(fn){for(var _len4=arguments.length,args=Array(_len4>1?_len4-1:0),_key4=1;_key4<_len4;_key4++)args[_key4-1]=arguments[_key4];return new(Function.prototype.bind.apply(Thread,[null].concat([fn],args)))}}]),Thread}();exports["default"]=Thread});